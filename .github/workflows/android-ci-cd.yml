name: React Native Android CI/CD

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main, staging]
  workflow_dispatch: # Manual trigger
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'staging'
        type: choice
        options: [staging, production]

env:
  NODE_VERSION: '20'

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    outputs:
      apk-name: ${{ steps.build.outputs.apk-name }}
      environment: ${{ steps.vars.outputs.environment }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm install

    - name: Validate Entry Point Configuration
      id: validate-entry
      run: |
        echo "--- Entry Point Validation ---"
        
        # Find all App component files in the project
        echo "Searching for App component files..."
        APP_FILES=$(find . -name "App.*" -type f | grep -v node_modules | grep -v __tests__)
        
        if [ -z "$APP_FILES" ]; then
          echo "ERROR: No App component files found in the project!"
          echo "The mobile team must create a main App component."
          exit 1
        fi
        
        echo "Found App component files:"
        echo "$APP_FILES"
        
        # Check what index.js expects
        IMPORT_LINE=$(grep "import.*App.*from" index.js | head -1)
        IMPORT_PATH=$(echo "$IMPORT_LINE" | sed -n "s/.*from '\([^']*\)'.*/\1/p")
        echo "Index.js expects: $IMPORT_PATH"
        
        # Verify the expected path exists
        if [ -f "${IMPORT_PATH}.tsx" ] || [ -f "${IMPORT_PATH}.js" ] || [ -f "${IMPORT_PATH}.ts" ] || [ -f "${IMPORT_PATH}.jsx" ]; then
          echo "SUCCESS: Import path resolves correctly"
        else
          echo "ERROR: CONFIGURATION MISMATCH"
          echo "Index.js imports from: '$IMPORT_PATH'"
          echo "But actual App files are at:"
          echo "$APP_FILES"
          echo ""
          echo "MOBILE TEAM ACTION REQUIRED:"
          echo "Update the import in index.js to match the actual file location"
          exit 1
        fi

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Determine environment
      id: vars
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.event.inputs.environment }}" == "production" ]]; then
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "BUILD_TYPE=Release" >> $GITHUB_ENV
        else
          echo "environment=staging" >> $GITHUB_OUTPUT
          echo "BUILD_TYPE=Release" >> $GITHUB_ENV
        fi
        
        # Generate build name
        BUILD_NAME="mum-mentor-${{ steps.vars.outputs.environment }}-$(date +'%Y%m%d-%H%M%S')"
        echo "BUILD_NAME=$BUILD_NAME" >> $GITHUB_ENV
        echo "Build environment: ${{ steps.vars.outputs.environment }}"

    - name: Build Android APK
      id: build
      run: |
        cd android
        chmod +x ./gradlew
        
        echo "Building ${{ env.BUILD_TYPE }} APK..."
        
        # Build the APK (uses debug signing as configured in their build.gradle)
        ./gradlew assembleRelease
        
        # Find the APK file
        APK_PATH=$(find . -name "*.apk" -path "*/release/*" ! -name "*unaligned*" | head -1)
        
        if [ -z "$APK_PATH" ]; then
          echo "ERROR: No APK file found!"
          find . -name "*.apk" | head -10
          exit 1
        fi
        
        echo "APK found at: $APK_PATH"
        
        # Copy and rename APK
        cp "$APK_PATH" "../${{ env.BUILD_NAME }}.apk"
        echo "apk-name=${{ env.BUILD_NAME }}.apk" >> $GITHUB_OUTPUT
        echo "SUCCESS: APK built successfully: ${{ env.BUILD_NAME }}.apk"

    - name: Verify APK
      run: |
        echo "APK Info:"
        ls -la *.apk
        echo "APK size: $(du -h "${{ env.BUILD_NAME }}.apk" | cut -f1)"

    - name: Upload to GitHub Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mum-mentor-${{ steps.vars.outputs.environment }}
        path: ${{ env.BUILD_NAME }}.apk
        retention-days: 30

  upload-to-drive:
    name: Upload to Google Drive
    needs: build-android
    runs-on: ubuntu-latest
    steps:
    - name: Download APK
      uses: actions/download-artifact@v4
      with:
        name: mum-mentor-${{ needs.build-android.outputs.environment }}
        
    - name: Upload to Google Drive
      uses: logickoder/g-drive-upload@main
      with:
        authType: 'oauth'
        clientId: ${{ secrets.GOOGLE_CLIENT_ID }}
        clientSecret: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        refreshToken: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
        filename: '${{ needs.build-android.outputs.apk-name }}'
        folderId: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        name: 'MumMentor-${{ needs.build-android.outputs.environment }}-latest.apk'
        overwrite: 'true'

    - name: Confirm Google Drive Upload
      run: |
        echo "SUCCESS: APK uploaded to Google Drive: MumMentor-${{ needs.build-android.outputs.environment }}-latest.apk"

  upload-to-appetize:
    name: Upload to Appetize
    needs: build-android
    runs-on: ubuntu-latest
    steps:
    - name: Download APK
      uses: actions/download-artifact@v4
      with:
        name: mum-mentor-${{ needs.build-android.outputs.environment }}
        
    - name: Upload to Appetize.io
      run: |
        echo "Uploading to Appetize.io..."
        RESPONSE=$(curl -s -X POST \
          "https://${{ secrets.APPETIZE_API_TOKEN }}@api.appetize.io/v1/apps" \
          -F "file=@${{ needs.build-android.outputs.apk-name }}" \
          -F "platform=android" \
          -F "note=Mum Mentor Mobile - ${{ needs.build-android.outputs.environment }} Build $(date +'%Y-%m-%d %H:%M')")
        
        echo "Appetize response: $RESPONSE"
        
        # Extract public URL if available
        if echo "$RESPONSE" | grep -q '"publicKey"'; then
          PUBLIC_KEY=$(echo "$RESPONSE" | grep -o '"publicKey":"[^"]*' | cut -d'"' -f4)
          echo "APPETIZE_PUBLIC_KEY=$PUBLIC_KEY" >> $GITHUB_ENV
          echo "Appetize app created: https://appetize.io/app/$PUBLIC_KEY"
        else
          echo "Could not extract public key from response"
        fi

  summary:
    name: Deployment Summary
    needs: [build-android, upload-to-drive, upload-to-appetize]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Create Summary
      run: |
        echo "## Mum Mentor Mobile Deployment" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ needs.build-android.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "**Build:** ${{ needs.build-android.outputs.apk-name }}" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ needs.build-android.result }}" == "success" ]]; then
          echo "**Status:** Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Outputs" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Artifacts: APK uploaded" >> $GITHUB_STEP_SUMMARY
          echo "- Google Drive: MumMentor-${{ needs.build-android.outputs.environment }}-latest.apk" >> $GITHUB_STEP_SUMMARY
          echo "- Appetize.io: Upload completed" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Status:** Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Issues" >> $GITHUB_STEP_SUMMARY
          echo "- Build process failed - check logs for details" >> $GITHUB_STEP_SUMMARY
        fi