name: React Native Mobile CI/CD

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main, staging]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'staging'
        type: choice
        options: [staging, production]
      platform:
        description: 'Platform to build'
        required: true
        default: 'android'
        type: choice
        options: [android, ios, both]

env:
  NODE_VERSION: '20'

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    if: github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both' || github.event.inputs.platform == ''
    outputs:
      apk-name: ${{ steps.build.outputs.apk-name }}
      environment: ${{ steps.vars.outputs.environment }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm install

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools: 34.0.0
        ndk: 25.1.8937393

    - name: Accept Android licenses
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

    - name: Determine environment
      id: vars
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.event.inputs.environment }}" == "production" ]]; then
          echo "environment=production" >> $GITHUB_OUTPUT
          ENV_SUFFIX="production"
        else
          echo "environment=staging" >> $GITHUB_OUTPUT
          ENV_SUFFIX="staging"
        fi
        
        BUILD_NAME="mum-mentor-$ENV_SUFFIX-$(date +'%Y%m%d-%H%M%S')"
        echo "BUILD_NAME=$BUILD_NAME" >> $GITHUB_ENV

    - name: Build Android APK
      id: build
      run: |
        cd android
        chmod +x ./gradlew
        
        echo "Building React Native 0.82.1 with New Architecture..."
        
        ./gradlew assembleDebug -PreactNativeArchitectures=arm64-v8a,x86_64 --stacktrace
        
        APK_PATH=$(find . -name "*.apk" -path "*/debug/*" ! -name "*unaligned*" | head -1)
        
        if [ -z "$APK_PATH" ]; then
          echo "ERROR: No APK file found!"
          find . -name "*.apk" | head -10
          exit 1
        fi
        
        echo "APK found at: $APK_PATH"
        cp "$APK_PATH" "../$BUILD_NAME.apk"
        echo "apk-name=$BUILD_NAME.apk" >> $GITHUB_OUTPUT
        echo "APK built successfully: $BUILD_NAME.apk"

    - name: Upload Android APK to Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-apk-${{ steps.vars.outputs.environment }}
        path: ${{ env.BUILD_NAME }}.apk
        retention-days: 30

  build-ios:
    name: Build iOS App
    runs-on: macos-latest
    if: github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both'
    outputs:
      environment: ${{ steps.vars.outputs.environment }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install JS dependencies
      run: |
        npm install

    - name: Install CocoaPods dependencies
      run: |
        cd ios
        pod install --repo-update

    - name: Determine environment
      id: vars
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.event.inputs.environment }}" == "production" ]]; then
          echo "environment=production" >> $GITHUB_OUTPUT
          SCHEME="MumMentorMobile"
        else
          echo "environment=staging" >> $GITHUB_OUTPUT
          SCHEME="MumMentorMobile"
        fi

    - name: Build iOS app
      run: |
        cd ios
        xcodebuild clean \
          -workspace MumMentorMobile.xcworkspace \
          -scheme MumMentorMobile \
          -configuration Debug \
          -destination 'generic/platform=iOS Simulator' \
          build

    - name: Archive iOS build
      run: |
        cd ios
        xcodebuild archive \
          -workspace MumMentorMobile.xcworkspace \
          -scheme MumMentorMobile \
          -configuration Debug \
          -archivePath ./build/MumMentorMobile.xcarchive \
          -destination 'generic/platform=iOS'

    - name: Upload iOS build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-${{ steps.vars.outputs.environment }}
        path: |
          ios/build/*.xcarchive
          ios/build/*.app
        retention-days: 30

  upload-android-to-drive:
    name: Upload Android to Google Drive
    needs: build-android
    runs-on: ubuntu-latest
    if: needs.build-android.result == 'success'
    
    steps:
    - name: Download APK
      uses: actions/download-artifact@v4
      with:
        name: android-apk-${{ needs.build-android.outputs.environment }}
        
    - name: Upload to Google Drive
      uses: logickoder/g-drive-upload@main
      with:
        authType: 'oauth'
        clientId: ${{ secrets.GOOGLE_CLIENT_ID }}
        clientSecret: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        refreshToken: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
        filename: '${{ needs.build-android.outputs.apk-name }}'
        folderId: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        name: 'MumMentor-${{ needs.build-android.outputs.environment }}-latest.apk'
        overwrite: 'true'

  upload-android-to-appetize:
    name: Upload Android to Appetize
    needs: build-android
    runs-on: ubuntu-latest
    if: needs.build-android.result == 'success'
    
    steps:
    - name: Download APK
      uses: actions/download-artifact@v4
      with:
        name: android-apk-${{ needs.build-android.outputs.environment }}
        
    - name: Upload to Appetize.io
      run: |
        echo "Uploading Android APK to Appetize.io..."
        RESPONSE=$(curl -s -X POST \
          "https://${{ secrets.APPETIZE_API_TOKEN }}@api.appetize.io/v1/apps" \
          -F "file=@${{ needs.build-android.outputs.apk-name }}" \
          -F "platform=android" \
          -F "note=Mum Mentor Mobile - ${{ needs.build-android.outputs.environment }} Build $(date +'%Y-%m-%d %H:%M')")
        
        echo "Appetize response: $RESPONSE"

  summary:
    name: Deployment Summary
    needs: [build-android, build-ios, upload-android-to-drive, upload-android-to-appetize]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Create Summary
      run: |
        echo "## Mum Mentor Mobile Deployment" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ needs.build-android.outputs.environment || needs.build-ios.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Android Build" >> $GITHUB_STEP_SUMMARY
        echo "- Status: ${{ needs.build-android.result }}" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ needs.build-android.result }}" == "success" ]]; then
          echo "- APK: ${{ needs.build-android.outputs.apk-name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Google Drive: ${{ needs.upload-android-to-drive.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Appetize: ${{ needs.upload-android-to-appetize.result }}" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### iOS Build" >> $GITHUB_STEP_SUMMARY
        echo "- Status: ${{ needs.build-ios.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
