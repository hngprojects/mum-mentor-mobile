name: React Native Android CI/CD

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main, staging]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'staging'
        type: choice
        options: [staging, production]

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm install

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Accept Android licenses
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

    - name: Build Android APK
      id: build
      run: |
        cd android
        chmod +x ./gradlew
        
        echo "=== Building Android APK ==="
        
        # First try debug build to see if it works
        ./gradlew assembleDebug --stacktrace
        
        echo "=== Debug build completed ==="
        
        # Check if APK was created
        if find . -name "*.apk" -path "*/debug/*" ! -name "*unaligned*" | head -1; then
          echo "Debug APK built successfully"
          APK_PATH=$(find . -name "*.apk" -path "*/debug/*" ! -name "*unaligned*" | head -1)
          echo "APK_PATH=$APK_PATH" >> $GITHUB_ENV
        else
          echo "No debug APK found, checking for any APK"
          find . -name "*.apk" | head -10
          exit 1
        fi

    - name: Upload APK to artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30

  build-release:
    name: Build Release APK
    runs-on: ubuntu-latest
    needs: build-android
    if: success()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm install

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Build Release APK
      run: |
        cd android
        chmod +x ./gradlew
        
        echo "=== Building Release APK ==="
        
        # Build release APK
        ./gradlew assembleRelease --stacktrace
        
        echo "=== Release build completed ==="
        
        # Check release APK
        if find . -name "*.apk" -path "*/release/*" ! -name "*unaligned*" | head -1; then
          echo "Release APK built successfully"
          RELEASE_APK=$(find . -name "*.apk" -path "*/release/*" ! -name "*unaligned*" | head -1)
          echo "Release APK: $RELEASE_APK"
        else
          echo "No release APK found"
          find . -name "*.apk" | head -10
        fi

    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: android-release-apk
        path: android/app/build/outputs/apk/release/app-release.apk
        retention-days: 30