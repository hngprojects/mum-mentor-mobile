name: React Native Mobile CI/CD

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main, staging]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'staging'
        type: choice
        options: [staging, production]

env:
  NODE_VERSION: '20'

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    outputs:
      apk-name: ${{ steps.build.outputs.apk-name }}
      environment: ${{ steps.vars.outputs.environment }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm install

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Accept Android licenses
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

    - name: Determine environment
      id: vars
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "environment=production" >> $GITHUB_OUTPUT
          ENV_SUFFIX="production"
        else
          echo "environment=staging" >> $GITHUB_OUTPUT
          ENV_SUFFIX="staging"
        fi
        
        BUILD_NAME="mum-mentor-$ENV_SUFFIX-$(date +'%Y%m%d-%H%M%S')"
        echo "BUILD_NAME=$BUILD_NAME" >> $GITHUB_ENV

    - name: Build Android APK
      id: build
      run: |
        cd android
        chmod +x ./gradlew
        ./gradlew assembleDebug --stacktrace
        
        APK_PATH=$(find . -name "*.apk" -path "*/debug/*" ! -name "*unaligned*" | head -1)
        
        if [ -z "$APK_PATH" ]; then
          echo "ERROR: No APK file found!"
          find . -name "*.apk" | head -10
          exit 1
        fi
        
        echo "APK found at: $APK_PATH"
        cp "$APK_PATH" "../$BUILD_NAME.apk"
        echo "apk-name=$BUILD_NAME.apk" >> $GITHUB_OUTPUT

    - name: Upload Android APK to Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-apk-${{ steps.vars.outputs.environment }}
        path: ${{ env.BUILD_NAME }}.apk
        retention-days: 30

  build-ios:
    name: Build iOS App
    runs-on: macos-latest
    outputs:
      environment: ${{ steps.vars.outputs.environment }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install JS dependencies
      run: |
        npm install

    - name: Setup Ruby and CocoaPods
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'

    - name: Install CocoaPods dependencies
      run: |
        cd ios
        pod install

    - name: Determine environment
      id: vars
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
          echo "environment=production" >> $GITHUB_OUTPUT
        else
          echo "environment=staging" >> $GITHUB_OUTPUT
        fi

    - name: Build iOS app for simulator
      run: |
        cd ios
        xcodebuild clean build \
          -workspace MumMentorMobile.xcworkspace \
          -scheme MumMentorMobile \
          -configuration Debug \
          -destination 'platform=iOS Simulator,name=iPhone 15' \
          CODE_SIGNING_ALLOWED=NO

    - name: Upload iOS build logs
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-logs-${{ steps.vars.outputs.environment }}
        path: ios/build/
        retention-days: 7

  upload-android-to-drive:
    name: Upload Android to Google Drive
    needs: build-android
    runs-on: ubuntu-latest
    
    steps:
    - name: Download APK
      uses: actions/download-artifact@v4
      with:
        name: android-apk-${{ needs.build-android.outputs.environment }}
        
    - name: Debug file check
      run: |
        echo "Current directory: $(pwd)"
        echo "Files in directory:"
        ls -la
        echo "APK filename: ${{ needs.build-android.outputs.apk-name }}"
        
    - name: Upload to Google Drive
      uses: logickoder/g-drive-upload@main
      with:
        authType: 'oauth'
        clientId: ${{ secrets.GOOGLE_CLIENT_ID }}
        clientSecret: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        refreshToken: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
        filename: '${{ needs.build-android.outputs.apk-name }}'
        folderId: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        name: 'MumMentor-${{ needs.build-android.outputs.environment }}-latest.apk'
        overwrite: 'true'

  upload-android-to-appetize:
    name: Upload Android to Appetize
    needs: build-android
    runs-on: ubuntu-latest
    
    steps:
    - name: Download APK
      uses: actions/download-artifact@v4
      with:
        name: android-apk-${{ needs.build-android.outputs.environment }}
        
    - name: Upload to Appetize.io
      run: |
        echo "Uploading Android APK to Appetize.io..."
        curl -X POST \
          "https://${{ secrets.APPETIZE_API_TOKEN }}@api.appetize.io/v1/apps" \
          -F "file=@${{ needs.build-android.outputs.apk-name }}" \
          -F "platform=android" \
          -F "note=Mum Mentor Mobile - ${{ needs.build-android.outputs.environment }}"

  summary:
    name: Deployment Summary
    needs: [build-android, build-ios, upload-android-to-drive, upload-android-to-appetize]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Create Summary
      run: |
        echo "## Mum Mentor Mobile Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ needs.build-android.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Android Build" >> $GITHUB_STEP_SUMMARY
        echo "- Build: ${{ needs.build-android.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Google Drive: ${{ needs.upload-android-to-drive.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Appetize: ${{ needs.upload-android-to-appetize.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### iOS Build" >> $GITHUB_STEP_SUMMARY
        echo "- Build: ${{ needs.build-ios.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Timestamp:** $(date)" >> $GITHUB_STEP_SUMMARY
