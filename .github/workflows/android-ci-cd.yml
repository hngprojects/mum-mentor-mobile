name: React Native Android CI/CD

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main, staging]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'staging'
        type: choice
        options: [staging, production]

env:
  NODE_VERSION: '20'

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    outputs:
      apk-name: ${{ steps.build.outputs.apk-name }}
      environment: ${{ steps.vars.outputs.environment }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: |
        npm install

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools: 34.0.0
        ndk: 25.1.8937393

    - name: Accept Android licenses
      run: |
        yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

    - name: Determine environment
      id: vars
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.event.inputs.environment }}" == "production" ]]; then
          echo "environment=production" >> $GITHUB_OUTPUT
          ENV_SUFFIX="production"
        else
          echo "environment=staging" >> $GITHUB_OUTPUT
          ENV_SUFFIX="staging"
        fi
        
        BUILD_NAME="mum-mentor-$ENV_SUFFIX-$(date +'%Y%m%d-%H%M%S')"
        echo "BUILD_NAME=$BUILD_NAME" >> $GITHUB_ENV

    - name: Build Android APK (New Architecture)
      id: build
      run: |
        cd android
        chmod +x ./gradlew
        
        echo "Building React Native 0.82.1 with New Architecture..."
        
        # Build with new architecture flags for React Native 0.82.1
        ./gradlew assembleDebug -PreactNativeArchitectures=arm64-v8a,x86_64 --stacktrace
        
        # Find the APK file
        APK_PATH=$(find . -name "*.apk" -path "*/debug/*" ! -name "*unaligned*" | head -1)
        
        if [ -z "$APK_PATH" ]; then
          echo "ERROR: No APK file found!"
          echo "Searching for any APK files:"
          find . -name "*.apk" | head -10
          echo "Build directory contents:"
          find . -name "build" -type d | head -10
          exit 1
        fi
        
        echo "APK found at: $APK_PATH"
        
        # Copy and rename APK
        cp "$APK_PATH" "../$BUILD_NAME.apk"
        echo "apk-name=$BUILD_NAME.apk" >> $GITHUB_OUTPUT
        echo "APK built successfully: $BUILD_NAME.apk"

    - name: Verify APK
      run: |
        echo "APK Info:"
        ls -la *.apk
        echo "APK size: $(du -h "$BUILD_NAME.apk" | cut -f1)"

    - name: Upload to GitHub Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mum-mentor-${{ steps.vars.outputs.environment }}
        path: ${{ env.BUILD_NAME }}.apk
        retention-days: 30

  upload-to-drive:
    name: Upload to Google Drive
    needs: build-android
    runs-on: ubuntu-latest
    if: needs.build-android.result == 'success'
    steps:
    - name: Download APK
      uses: actions/download-artifact@v4
      with:
        name: mum-mentor-${{ needs.build-android.outputs.environment }}
        
    - name: Upload to Google Drive
      uses: logickoder/g-drive-upload@main
      with:
        authType: 'oauth'
        clientId: ${{ secrets.GOOGLE_CLIENT_ID }}
        clientSecret: ${{ secrets.GOOGLE_CLIENT_SECRET }}
        refreshToken: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
        filename: '${{ needs.build-android.outputs.apk-name }}'
        folderId: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        name: 'MumMentor-${{ needs.build-android.outputs.environment }}-latest.apk'
        overwrite: 'true'

    - name: Confirm Google Drive Upload
      run: |
        echo "APK uploaded to Google Drive: MumMentor-${{ needs.build-android.outputs.environment }}-latest.apk"

  upload-to-appetize:
    name: Upload to Appetize
    needs: build-android
    runs-on: ubuntu-latest
    if: needs.build-android.result == 'success'
    steps:
    - name: Download APK
      uses: actions/download-artifact@v4
      with:
        name: mum-mentor-${{ needs.build-android.outputs.environment }}
        
    - name: Upload to Appetize.io
      run: |
        echo "Uploading to Appetize.io..."
        RESPONSE=$(curl -s -X POST \
          "https://${{ secrets.APPETIZE_API_TOKEN }}@api.appetize.io/v1/apps" \
          -F "file=@${{ needs.build-android.outputs.apk-name }}" \
          -F "platform=android" \
          -F "note=Mum Mentor Mobile - ${{ needs.build-android.outputs.environment }} Build $(date +'%Y-%m-%d %H:%M')")
        
        echo "Appetize response: $RESPONSE"
        
        if echo "$RESPONSE" | grep -q '"publicKey"'; then
          PUBLIC_KEY=$(echo "$RESPONSE" | grep -o '"publicKey":"[^"]*' | cut -d'"' -f4)
          echo "Appetize app created: https://appetize.io/app/$PUBLIC_KEY"
        else
          echo "Could not extract public key from response"
        fi

  summary:
    name: Deployment Summary
    needs: [build-android, upload-to-drive, upload-to-appetize]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Create Summary
      run: |
        echo "## Mum Mentor Mobile Deployment" >> $GITHUB_STEP_SUMMARY
        echo "**Environment:** ${{ needs.build-android.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "**Build:** ${{ needs.build-android.outputs.apk-name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ needs.build-android.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Outputs" >> $GITHUB_STEP_SUMMARY
        echo "- GitHub Artifacts: ${{ needs.build-android.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Google Drive: ${{ needs.upload-to-drive.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Appetize.io: ${{ needs.upload-to-appetize.result }}" >> $GITHUB_STEP_SUMMARY